# PWA (Progressive Web App) 구현

**작성일**: 2026-02-09

## 1. PWA란

Progressive Web App(PWA)은 웹 기술로 만든 앱을 네이티브 앱처럼 사용할 수 있게 하는 기술이다. 핵심 구성 요소는 다음 세 가지다.

| 구성 요소 | 역할 |
|---|---|
| **Web App Manifest** | 앱 이름, 아이콘, 시작 URL, 표시 모드 등 메타데이터 정의 |
| **Service Worker** | 네트워크 프록시로 동작하여 오프라인 캐싱, 백그라운드 동기화 처리 |
| **HTTPS** | Service Worker 등록의 필수 조건 (localhost 제외) |

이 세 조건을 충족하면 브라우저가 앱을 "설치 가능"으로 인식한다.

## 2. 동작 원리

### 2.1 Service Worker 라이프사이클

```
등록(register) → 설치(install) → 활성화(activate) → fetch 이벤트 가로채기
```

1. **등록**: 브라우저가 `sw.js`를 다운로드하여 백그라운드에 등록
2. **설치**: 정적 자산을 Cache Storage에 프리캐싱
3. **활성화**: 이전 캐시 정리 후 네트워크 요청 가로채기 시작
4. **fetch**: 요청이 들어오면 캐시 우선/네트워크 우선 등 전략에 따라 응답

### 2.2 캐싱 전략

| 전략 | 설명 | 이 프로젝트 적용 |
|---|---|---|
| **Precache** | 빌드 시 정적 자산을 캐시에 미리 저장 | JS, CSS, HTML, 이미지, 폰트 |
| **CacheFirst** | 캐시에 있으면 캐시 반환, 없으면 네트워크 | Google Fonts |
| **NetworkFirst** | 네트워크 우선, 실패 시 캐시 | (미사용) |

### 2.3 앱 설치 흐름

**Android (Chrome 등)**:
```
브라우저가 manifest + SW 감지
  → beforeinstallprompt 이벤트 발생
  → 앱에서 이벤트 저장 → 사용자에게 설치 버튼 표시
  → 버튼 클릭 → prompt() 호출 → 네이티브 설치 다이얼로그
  → 수락 시 appinstalled 이벤트 발생
```

**iOS (Safari)**:
```
beforeinstallprompt 미지원
  → 수동으로 공유(↑) → "홈 화면에 추가" 안내 필요
  → standalone 모드로 실행됨
```

## 3. 프로젝트 구현

### 3.1 파일 구조

```
├── index.html                              # PWA 메타태그 (apple-mobile-web-app 등)
├── vite.config.ts                          # vite-plugin-pwa 설정
├── public/
│   ├── favicon.svg                         # 파비콘
│   ├── apple-touch-icon.png                # iOS 홈 화면 아이콘
│   ├── pwa-192x192.png                     # PWA 아이콘 (192x192)
│   └── pwa-512x512.png                     # PWA 아이콘 (512x512, maskable 겸용)
├── src/
│   ├── hooks/
│   │   └── use-pwa-install.ts              # PWA 설치 상태 관리 훅
│   └── components/
│       ├── pwa-install-banner.tsx           # 설치 안내 배너 UI
│       └── layout.tsx                       # 배너 배치 (footer 위)
└── dist/                                   # (빌드 결과물)
    ├── manifest.webmanifest                # 생성된 Web App Manifest
    ├── sw.js                               # 생성된 Service Worker
    └── workbox-*.js                        # Workbox 런타임
```

### 3.2 vite-plugin-pwa 설정

**파일**: `vite.config.ts`

```typescript
VitePWA({
  registerType: 'autoUpdate',           // SW 업데이트 시 자동 적용
  includeAssets: ['favicon.svg', 'apple-touch-icon.png'],
  manifest: {
    name: '정보보안기사',
    short_name: '정보보안기사',
    description: '정보보안기사 자격증 시험 대비 문제 풀이 및 이론 학습',
    theme_color: '#1d4ed8',
    background_color: '#0f172a',
    display: 'standalone',              // 브라우저 UI 숨김
    scope: '/',
    start_url: '/',
    icons: [
      { src: 'pwa-192x192.png', sizes: '192x192', type: 'image/png' },
      { src: 'pwa-512x512.png', sizes: '512x512', type: 'image/png' },
      { src: 'pwa-512x512.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' },
    ],
  },
  workbox: {
    globPatterns: ['**/*.{js,css,html,svg,png,woff2}'],
    navigateFallback: 'index.html',     // SPA 라우팅 폴백
    runtimeCaching: [
      {
        urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
        handler: 'CacheFirst',
        options: {
          cacheName: 'google-fonts-cache',
          expiration: { maxEntries: 10, maxAgeSeconds: 60 * 60 * 24 * 365 },
        },
      },
    ],
  },
})
```

주요 설정 설명:

| 속성 | 설명 |
|---|---|
| `registerType: 'autoUpdate'` | 새 SW 감지 시 사용자 확인 없이 자동 교체 |
| `display: 'standalone'` | 설치 시 브라우저 주소창 없이 앱처럼 표시 |
| `navigateFallback` | SPA 라우팅을 위해 모든 내비게이션을 `index.html`로 폴백 |
| `globPatterns` | 프리캐시할 파일 패턴 |
| `purpose: 'maskable'` | Android 적응형 아이콘 지원 |

### 3.3 HTML 메타태그

**파일**: `index.html`

```html
<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="정보보안기사" />
<meta name="theme-color" content="#1d4ed8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
```

| 태그 | 역할 |
|---|---|
| `apple-touch-icon` | iOS 홈 화면 아이콘 |
| `apple-mobile-web-app-capable` | iOS에서 standalone 모드 활성화 |
| `apple-mobile-web-app-status-bar-style` | iOS 상태바 스타일 (투명 배경) |
| `theme-color` | 브라우저 주소창/상태바 색상 |
| `viewport-fit=cover` | iOS 노치 영역까지 콘텐츠 확장 |

### 3.4 설치 안내 배너

#### `usePwaInstall` 훅

**파일**: `src/hooks/use-pwa-install.ts`

플랫폼 감지, 설치 프롬프트 관리, dismiss 상태를 하나의 훅으로 캡슐화한다.

```typescript
const { platform, showBanner, install, dismiss } = usePwaInstall();
```

| 반환값 | 타입 | 설명 |
|---|---|---|
| `platform` | `"ios" \| "android" \| "other"` | 현재 플랫폼 |
| `showBanner` | `boolean` | 배너 표시 여부 |
| `install` | `() => Promise<void>` | Android 설치 프롬프트 호출 |
| `dismiss` | `() => void` | 배너 닫기 (localStorage 저장) |

**배너 표시 조건**:
```
showBanner = !installed && !dismissed && (iOS이거나 Android에서 beforeinstallprompt 발생)
```

- `installed`: `display-mode: standalone` 미디어 쿼리 또는 `navigator.standalone`으로 감지
- `dismissed`: `localStorage`의 `pwa-install-dismissed` 키로 관리
- `beforeinstallprompt`: Android Chrome에서 설치 가능 시 브라우저가 발생시키는 이벤트

**플랫폼 감지 로직**:
```typescript
function detectPlatform(): Platform {
  const ua = navigator.userAgent;
  if (/iPad|iPhone|iPod/.test(ua) && "standalone" in navigator) return "ios";
  if (/Android/.test(ua)) return "android";
  return "other";
}
```

- iOS: User-Agent에 Apple 기기명 + `navigator.standalone` 속성 존재 여부
- Android: User-Agent에 `Android` 포함 여부
- 그 외(데스크톱 등): `"other"` → 배너 미표시

#### `PwaInstallBanner` 컴포넌트

**파일**: `src/components/pwa-install-banner.tsx`

플랫폼에 따라 다른 UI를 제공하는 하단 고정 배너.

| 플랫폼 | UI |
|---|---|
| iOS | 공유(↑) 아이콘 + "홈 화면에 추가" 안내 텍스트 |
| Android | "앱을 설치하면 더 빠르게 이용할 수 있어요" + 설치 버튼 |

**배치 위치**: `layout.tsx`에서 `<main>` 과 `<footer>` 사이.

```tsx
<main>...</main>
<PwaInstallBanner />    {/* ← footer 바로 위 */}
<footer>...</footer>
```

`sticky bottom-0`으로 화면 하단에 고정되며, 닫기(X) 클릭 시 localStorage에 저장되어 재방문 시에도 다시 표시되지 않는다.

## 4. 빌드 결과물

`pnpm build` 실행 시 vite-plugin-pwa가 자동으로 생성하는 파일:

| 파일 | 설명 |
|---|---|
| `dist/manifest.webmanifest` | Web App Manifest (앱 메타데이터) |
| `dist/sw.js` | Service Worker (Workbox 기반) |
| `dist/workbox-*.js` | Workbox 런타임 라이브러리 |

SW 등록은 플러그인이 `index.html`에 자동 삽입하는 스크립트가 처리한다. `registerType: 'autoUpdate'`이므로 새 버전 배포 시 백그라운드에서 SW가 갱신되고 다음 방문 시 적용된다.

## 5. 아이콘 요구사항

| 파일 | 크기 | 용도 |
|---|---|---|
| `pwa-192x192.png` | 192x192 | Android 홈 화면 아이콘 |
| `pwa-512x512.png` | 512x512 | Android 스플래시, maskable 아이콘 |
| `apple-touch-icon.png` | 180x180 | iOS 홈 화면 아이콘 |
| `favicon.svg` | 벡터 | 브라우저 탭 아이콘 |

maskable 아이콘은 safe zone(중앙 80% 영역) 안에 핵심 그래픽이 있어야 한다. 시스템이 원형/사각형 등으로 잘라내도 핵심 부분이 보존된다.

## 6. 플랫폼별 차이 정리

| | Android Chrome | iOS Safari | 데스크톱 Chrome |
|---|---|---|---|
| `beforeinstallprompt` | O | X | O |
| `appinstalled` 이벤트 | O | X | O |
| `navigator.standalone` | X | O | X |
| `display-mode: standalone` | O | O | O |
| 설치 방법 | 네이티브 프롬프트 | 공유 → 홈 화면에 추가 | 주소창 설치 버튼 |
| 배너 동작 | 설치 버튼 표시 | 수동 안내 표시 | 미표시 |
